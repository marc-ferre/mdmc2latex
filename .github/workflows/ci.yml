name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up apt dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc cpanminus git build-essential libgd-dev libxml2-dev

      - name: Install Perl modules
        run: |
          sudo cpanm -n Pandoc Term::ANSIColor

      - name: Run Perl unit tests
        run: |
          perl -V
          perl test_mdmc2latex.pl
          perl test_sanitize_tex.pl || true

      - name: Convert sample and dry-run sanitize and produce output
        run: |
          perl mdmc2latex.pl examples/sample_withltcaptype.mdmc --ltcaptype=table
          ls -la examples
          perl tools/sanitize_tex.pl --ltcaptype=table --dry-run examples || true

      - name: Run sanitize via mdmc2latex (--sanitize) in dry-run
        run: |
          perl mdmc2latex.pl --sanitize --sanitize-dry-run --ltcaptype=table examples/sample_withltcaptype.mdmc || true
          ls -la examples

      - name: Upload generated tex artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-tex
          path: |
            examples/*.mdmc.tex

  compile:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifact from test
        uses: actions/download-artifact@v4
        with:
          name: generated-tex

      - name: Install TeX Live (full)
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-full

      - name: Compile generated sample(s) if full document
        run: |
          ls -la examples || true
          for f in examples/*.mdmc.tex; do
            if [ -f "$f" ]; then
              if grep -q '\\documentclass' "$f" || grep -q '\\begin{document}' "$f"; then
                echo "Compiling $f";
                pdflatex -interaction=nonstopmode -halt-on-error -output-directory=examples "$f" || true;
              else
                echo "Skipping $f (no \\documentclass or \\begin{document})";
              fi
            fi
          done
